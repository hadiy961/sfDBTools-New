name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.5"
          cache: true

      - name: Build linux amd64 (Ubuntu 20+ / CentOS 7+)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          TAG_REF="${GITHUB_REF_NAME}"          # v1.0.0
          VERSION="${TAG_REF#v}"               # 1.0.0
          COMMIT="${GITHUB_SHA::7}"
          BUILD_DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          LDFLAGS="-s -w"
          LDFLAGS+=" -X sfdbtools/pkg/version.Version=${VERSION}"
          LDFLAGS+=" -X sfdbtools/pkg/version.Commit=${COMMIT}"
          LDFLAGS+=" -X sfdbtools/pkg/version.BuildDate=${BUILD_DATE}"

          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
            go build -trimpath -ldflags "${LDFLAGS}" \
            -o dist/sfDBTools .

          (cd dist && tar -czf "sfDBTools_${VERSION}_linux_amd64.tar.gz" sfDBTools)
          (cd dist && cp "sfDBTools_${VERSION}_linux_amd64.tar.gz" "sfDBTools_linux_amd64.tar.gz")
          (cd dist && sha256sum "sfDBTools_${VERSION}_linux_amd64.tar.gz" > "sfDBTools_${VERSION}_linux_amd64.sha256")

      - name: Build .deb and .rpm packages
        shell: bash
        run: |
          set -euo pipefail

          TAG_REF="${GITHUB_REF_NAME}"
          VERSION="${TAG_REF#v}"

          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev rubygems build-essential rpm
          sudo gem install --no-document fpm

          PKGROOT="$(mktemp -d)"
          mkdir -p "${PKGROOT}/usr/bin" "${PKGROOT}/etc/sfDBTools"

          install -m 0755 dist/sfDBTools "${PKGROOT}/usr/bin/sfDBTools"
          ln -sf sfDBTools "${PKGROOT}/usr/bin/sfdbtools"

          # Install a default config file (dpkg/rpm will treat as config file)
          install -m 0644 config/config.example.yaml "${PKGROOT}/etc/sfDBTools/config.yaml"

          # DEB (Ubuntu/Debian)
          fpm -s dir -t deb \
            -n sfdbtools \
            -v "${VERSION}" \
            --architecture amd64 \
            --description "sfDBTools - MySQL/MariaDB backup & management CLI" \
            --maintainer "sfDBTools" \
            --license "Internal" \
            --config-files /etc/sfDBTools/config.yaml \
            -C "${PKGROOT}" \
            -p "dist/sfdbtools_${VERSION}_amd64.deb" \
            .
          cp "dist/sfdbtools_${VERSION}_amd64.deb" "dist/sfdbtools_latest_amd64.deb"

          # RPM (CentOS/RHEL 7+)
          fpm -s dir -t rpm \
            -n sfdbtools \
            -v "${VERSION}" \
            --architecture x86_64 \
            --description "sfDBTools - MySQL/MariaDB backup & management CLI" \
            --maintainer "sfDBTools" \
            --license "Internal" \
            --config-files /etc/sfDBTools/config.yaml \
            -C "${PKGROOT}" \
            -p "dist/sfdbtools-${VERSION}-1.x86_64.rpm" \
            .
          cp "dist/sfdbtools-${VERSION}-1.x86_64.rpm" "dist/sfdbtools-latest-1.x86_64.rpm"

          (cd dist && sha256sum sfdbtools_*.* > "sfdbtools_${VERSION}_packages.sha256")

      - name: Generate changelog
        shell: bash
        run: |
          set -euo pipefail

          TAG_REF="${GITHUB_REF_NAME}"          # v1.0.1
          VERSION="${TAG_REF#v}"               # 1.0.1

          # Cari tag sebelumnya (semver sort), selain tag saat ini.
          PREV_TAG="$(git tag --list 'v*' --sort=-v:refname | grep -v "^${TAG_REF}$" | head -n 1 || true)"

          if [[ -n "${PREV_TAG}" ]]; then
            bash ./scripts/generate_changelog.sh --version "${VERSION}" --from "${PREV_TAG}" --to "${TAG_REF}" --out "dist/CHANGELOG_${VERSION}.md"
          else
            bash ./scripts/generate_changelog.sh --version "${VERSION}" --to "${TAG_REF}" --out "dist/CHANGELOG_${VERSION}.md"
          fi

          cp "dist/CHANGELOG_${VERSION}.md" "dist/CHANGELOG_latest.md"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            dist/CHANGELOG_[0-9]*.[0-9]*.[0-9]*.md
            dist/CHANGELOG_latest.md
            dist/sfDBTools_[0-9]*_linux_amd64.tar.gz
            dist/sfDBTools_linux_amd64.tar.gz
            dist/sfDBTools_[0-9]*_linux_amd64.sha256
            dist/sfdbtools_[0-9]*_amd64.deb
            dist/sfdbtools_latest_amd64.deb
            dist/sfdbtools-[0-9]*-1.x86_64.rpm
            dist/sfdbtools-latest-1.x86_64.rpm
            dist/sfdbtools_*_packages.sha256